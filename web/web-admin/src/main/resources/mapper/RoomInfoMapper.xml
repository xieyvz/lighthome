<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xieyv.lighthome.web.admin.mapper.RoomInfoMapper">

    <resultMap id="RoomItemVoMap" type="com.xieyv.lighthome.web.admin.vo.room.RoomItemVo">
        <id property="id" column="id"/>
        <result property="roomNumber" column="room_number"/>
        <result property="rent" column="rent"/>
        <result property="communityId" column="community_id"/>
        <result property="isRelease" column="is_release"/>
        <result property="leaseEndDate" column="lease_end_date"/>
        <result property="isCheckIn" column="is_check_in"/>
        <association property="communityInfo" javaType="com.xieyv.lighthome.model.entity.CommunityInfo">
            <id property="id" column="comm_id"/>
            <result property="name" column="name"/>
            <result property="introduction" column="introduction"/>
            <result property="districtId" column="district_id"/>
            <result property="districtName" column="district_name"/>
            <result property="cityId" column="city_id"/>
            <result property="cityName" column="city_name"/>
            <result property="provinceId" column="province_id"/>
            <result property="provinceName" column="province_name"/>
            <result property="addressDetail" column="address_detail"/>
            <result property="latitude" column="latitude"/>
            <result property="longitude" column="longitude"/>
            <result property="phone" column="phone"/>
            <result property="isRelease" column="comm_is_release"/>
        </association>
    </resultMap>

    <select id="listByQueryVo" resultMap="RoomItemVoMap">
        select ri.id as id,
               ri.room_number as room_number,
               ri.rent as rent,
               ri.community_id as community_id,
               ri.is_release as is_release,
               lt.room_id is not null as is_check_in,
               lt.lease_end_date as lease_end_date,
               ci.id as comm_id,
               ci.name as name,
               ci.introduction as introduction,
               ci.district_id as district_id,
               ci.district_name as district_name,
               ci.city_id as city_id,
               ci.city_name as city_name,
               ci.province_id as province_id,
               ci.province_name as province_name,
               ci.address_detail as address_detail,
               ci.latitude as latitude,
               ci.longitude as longitude,
               ci.phone as phone,
               ci.is_release as comm_is_release
        from room_info as ri
                 left join
             (select room_id, lease_end_date from lease_agreement
                                             where is_deleted=0
                                               and id in
                (select lease_term_id from room_lease_term where is_deleted=0))lt
             on ri.id=lt.room_id
                 left join
             community_info as ci
             on ri.community_id=ci.id
        <where>
            and ri.is_deleted=0
            and ci.is_deleted=0
            <if test="queryVo.provinceId != null">
                and ci.province_id=#{queryVo.provinceId}
            </if>
            <if test="queryVo.cityId != null">
                and ci.city_id=#{queryVo.cityId}
            </if>
            <if test="queryVo.districtId != null">
                and ci.district_id = #{queryVo.districtId}
            </if>
            <if test="queryVo.apartmentId != null">
                and ri.community_id = #{queryVo.apartmentId}
            </if>
        </where>
    </select>
</mapper>
